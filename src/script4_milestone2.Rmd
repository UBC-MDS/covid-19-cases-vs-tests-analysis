---
title: "script4_milestone2"
author: "Neel Phaterpekar"
date: "24/11/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(broom)
library(infer)
library(knitr)
library(tidyverse)
library(car)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
covid_all_country <-  read_csv("../data/owid-covid-data.csv", guess_max = 5000)
covid_CAN_USA <- covid_all_country %>% 
    filter(iso_code=="CAN"| iso_code =="USA") %>% 
    filter(date < "2020-11-01") %>% 
    filter(new_cases != 0 & new_tests !=0) %>% 
    select("iso_code", "date", "location", "new_tests", "new_cases") %>% 
    drop_na(new_tests, new_cases) %>% 
    mutate(response_ratio = new_tests/new_cases) %>% 
    mutate(log_response_ratio = log10(response_ratio),
           inverse_ratio = 1/response_ratio)
covid_CAN_USA
```



```{r}
can_data <- covid_CAN_USA %>% 
  filter(iso_code == 'CAN')

us_data <- covid_CAN_USA %>%
  filter(iso_code == 'USA') %>% 
  drop_na()
qqPlot(can_data$response_ratio)

```

```{r}
shapiro.test(can_data$response_ratio)
```
```{r}
covid_bartlett <- bartlett.test(response_ratio ~ location, data = covid_CAN_USA) %>% 
    tidy()
covid_bartlett
```


```{r}
# Manually calculating estimates 

covid_stats <- covid_CAN_USA %>%    # for personal reference 
  group_by(location) %>% 
  summarise(n = n(),
            mu = mean(response_ratio),
            median = median(response_ratio),
            sd = sd (response_ratio),
            se = sd / (sqrt(n))
  )

covid_stats
```


```{r}
covid_CAN_USA_plot <- covid_CAN_USA %>%
  mutate(across(iso_code, fct_relabel, .fun = str_wrap, width = 30)) %>%
  ggplot(aes(x = response_ratio, y = iso_code)) +
  geom_violin(fill = "yellow", 
              alpha = .1, adjust = .8, trim = TRUE) +
  stat_summary(fun = mean,
               colour = "red",
               geom = "point") +
  scale_x_continuous(labels = scales::label_number_si()) +
  labs(title = "COVID-19 Response Ratio - Canada vs USA",
       subtitle = "Means shown in red",
       x = "Mean of Response Ratio in both countries",
       y = "Country")
covid_CAN_USA_plot
```


1.  $H_0$: The mean response ratio in Canada is equal to the mean response ratio in the United States

    $H_a$: The mean response ratio in Canada is **not** equal to the mean response ratio in the United States


```{r welch test}

welch_test <- t.test( response_ratio ~ location, data = covid_CAN_USA)
tidy(welch_test)
saveRDS()
```


```{r wilcox test}
wilcox_test <- wilcox.test(response_ratio ~ location, data=covid_CAN_USA)
wilcox_test %>% tidy()
```

```{r simulation based approach - mean}
ratio_means <- covid_CAN_USA %>% 
  select(location, response_ratio) %>% 
  drop_na() %>% 
  group_by(location) %>% 
  nest() %>% 
  mutate(mean = map_dbl(data, ~mean(.x$response_ratio)),
         median = map_dbl(data, ~median(.x$response_ratio)))

test_stat <- diff(ratio_means$mean)

null_dist <- covid_CAN_USA %>% 
  specify(formula = response_ratio ~ location) %>% 
  hypothesize(null = 'independence') %>% 
  generate(reps = 1000, type = 'permute') %>% 
  calculate(stat = 'diff in means', order = c('Canada', 'United States'))

threshold <- quantile(null_dist$stat, c(0.025, 0.975))

null_dist_plot <- visualize(null_dist) + 
             geom_vline(xintercept = c(threshold[1], threshold[2]),
             color = 'black',
             lty = 4) + 
     geom_vline(xintercept = test_stat, color = 'red')

ggsave(filename = 'null.png')
p_val <- null_dist %>% 
     get_pvalue(obs_stat = test_stat, direction = 'both')
    
null_dist_plot
null_dist
threshold
ratio_means
```

```{r}
test_stat <- diff(ratio_means$median)
path <- 'img/'
null_dist <- covid_CAN_USA %>% 
  specify(formula = response_ratio ~ location) %>% 
  hypothesize(null = 'independence') %>% 
  generate(reps = 1000, type = 'permute') %>% 
  calculate(stat = 'diff in medians', order = c('Canada', 'United States'))

threshold <- quantile(null_dist$stat, c(0.025, 0.975))

null_dist_plot <- visualize(null_dist) + 
             geom_vline(xintercept = c(threshold[1], threshold[2]),
             color = 'black',
             lty = 4) + 
     geom_vline(xintercept = test_stat, color = 'red') + 
   xlab('Difference in Medians') + 
   ylab('Count')
ggsave((filename = 'img/null.png'))


p_val <- null_dist %>% 
     get_pvalue(obs_stat = test_stat, direction = 'both')

null_dist_plot
null_dist
threshold
```






